#!/usr/bin/env bash
# Make Nginx is running as the nginx user

# Check if Nginx is installed
if ! command -v nginx &> /dev/null; then
    echo "Nginx is not installed."
    exit 1
fi

# Update the Nginx configuration file to run as the nginx user and listen on port 8080
NGINX_CONF="/etc/nginx/nginx.conf"

# Make a backup of the original configuration file
cp "$NGINX_CONF" "${NGINX_CONF}.bak"

# Update user to nginx and listen on port 8080
sed -i 's/^user .*/user nginx;/g' "$NGINX_CONF"
sed -i 's/listen .*/listen 8080;/g' /etc/nginx/sites-available/default

# Ensure that the nginx user exists
if ! id -u nginx &> /dev/null; then
    echo "Creating nginx user..."
    useradd -r -s /sbin/nologin nginx
fi

# Restart Nginx to apply changes
nginx -t && systemctl restart nginx

# Verify that Nginx is running as the nginx user
echo "Verifying Nginx user..."
ps aux | grep 'nginx' | grep -v 'grep'

# Check if Nginx is listening on port 8080
echo "Verifying Nginx port..."
ss -tuln | grep ':8080'
